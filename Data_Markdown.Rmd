---
title: "Nasville Music Venues Research"
author: "Sofia Fasullo"
date: "2023-03-21"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

Start by loading in packages
```{r}
library(tidyverse)
library(sf)
#library(RSocrata)
library(tidycensus)
#library(tigris)
#library(viridis)
#library(viridisLite)
library(mapview)
library(dplyr)
#library(foreign)
#library(tidygeocoder)
```
Load venue datasets
```{r}
## load venue data (last updated: 07/03/2023)

venues = read.csv("~/GitHub/Nashville_IMV/data/venue_tables/venue_table_detailed_7_3.csv") %>% st_as_sf(coords = c("x","y"), remove = FALSE,crs= 4326, na.fail = FALSE)

## venue APN data (last updated: 04/16/2023) - use this dataset as a "key" for all tabular joins
venue_admin_key_table = read.csv("~/GitHub/Nashville_IMV/data/venue_tables/simple_table_4_16.csv")

## data dictionary for detailed venue table
data_dictionary_load = read.csv("~/Github/Nashville_IMV/data/venue_tables/data_dictionary_venue_detailed_7_3.csv", header=F)
data_dictionary_view = t(data_dictionary_load) %>% as.data.frame() %>% mutate(col_name=V1,col_definition=V2,survey_question=V3) %>% select(-c(V1,V2,V3))
#view(data_dictionary_view)

```


NOTE: possiblility to streamline this system in the future by reading .R files into this markdown rather than having all this code re-written

#Joining Census Data to Parent Geography

- Use *~/Github/Nashville_IMV/R/clean_data.R* clean the music venue database so that it is in a format compatible to join with other data sets. 

- Then use the code below to inspect and visualize this information.

```{r}
## Sofia Fasullo's API key - replace with your own, get at https://api.census.gov/data/key_signup.html
API_key = "c03e04624fa724c446d835b3c313e3f11aa54c2d" 
census_api_key(API_key, overwrite = TRUE)

## Look through existing acs variables and choose a few to examine: filter geography to block group
acs_variable_list.2020 <- load_variables(2020,"acs5")
acs_variable_list.2010 <- load_variables(2010,"acs5")

## Set up lists of variables to grab
acs_vars_20 <- c("B01001_001E", # ACS total Pop estimate
              "B06011_001E", # Median income in past 12 months
              "B09021_008E", # 18-34 yr olds estimate
              "B25032_013E", # total renter-occupied units estimate
              "B25031_001E" # median rent estimate
              )

acs_vars_10 <- c("B01001_001E", # ACS total Pop estimate
              "B06011_001E", # Median income in past 12 months
              "B21005_002E", # 18-34 yr olds estimate
              "B25013_007E", # total renter-occupied units estimate
              "B25064_001E" # median rent estimate
              )

## Grab block-level for Davidson County: 2020 and 2010
acs2020 <- get_acs(geography = "tract",
                   year = 2020,
                   variables = (acs_vars_20),
                   geometry = TRUE,
                   state = "TN",
                   county = "Davidson",
                   output = "wide") %>%
  select(GEOID, NAME, acs_vars_20) %>%
  rename(total_pop_est = B01001_001E,
         median_income_est = B06011_001E,
         pop_18_34_est = B09021_008E,
         rental_units_est = B25032_013E,
         med_rent_est = B25031_001E) %>%
  mutate(year = 2020) %>% st_transform(4326)

acs2010 <- get_acs(geography = "tract",
                   year = 2010,
                   variables = all_of(acs_vars_10),
                   geometry = TRUE,
                   state = "TN",
                   county = "Davidson",
                   output = "wide") %>%
  select(GEOID, NAME, acs_vars_10) %>%
  rename(total_pop_est = B01001_001E,
         median_income_est = B06011_001E,
         pop_18_34_est = B21005_002E,
         rental_units_est = B25013_007E,
         med_rent_est = B25064_001E) %>%
  mutate(year = 2010) %>% st_transform(4326)

## combining tables in "long data" form - not used currently
#full_table <- rbind(acs2010, acs2020)
```

```{r}
## loading "parent" geography: city council districts (the match up to census block boundaries and )
#council_districts = st_read("https://data.nashville.gov/resource/iw7r-m8qr.geojson") %>% select(council_district, geometry) %>% st_transform(crs=4326)
planning_districts = st_read("~/Github/Nashville_IMV/data/metro/Subareas/Subareas.shp") %>% st_transform(crs=4326)
planning_districts$area = st_area(planning_districts)
```

Idea is 2 different "big" tables: one organized by census tract and one organized by venue (for ease of different access)

```{r}
## create new table of census acs data to manipulate
census10 = acs2010
census10[is.na(census10)] <- 0 #allow for calculations to be made

## calculate new columns (in this case, area, population density, and preparation to calculate average median income)
census10$area10 = st_area(census10) # this is in sq meters
census10 = census10 %>% mutate(pop_dens10 = total_pop_est/area10, med_incxpop = median_income_est*total_pop_est, perc_youth = round((pop_18_34_est/total_pop_est)*100,1), med_rentxpop = med_rent_est*total_pop_est)

## join blocks to council districts and aggregate block data by council districts
plan10 = st_join(planning_districts,census10) %>% group_by(Communit_1) %>% summarize(tot_pop10 = sum(total_pop_est), avg_med_inc10 = (sum(med_incxpop)/tot_pop10), avg_dens10 = mean(pop_dens10), tot_youth10 = sum(pop_18_34_est), perc_youth_10 = mean(perc_youth), avg_med_rent10 = (sum(med_rentxpop)/tot_pop10), tot_rent_HH_10 = sum(rental_units_est))

## repeat process with 2020 data
census20 = acs2020
census20[is.na(census20)] <- 0
census20$area20 = st_area(census20)
census20 = census20 %>% mutate(pop_dens20 = total_pop_est/area20, med_incxpop = median_income_est*total_pop_est, perc_youth = round((pop_18_34_est/total_pop_est)*100,1), med_rentxpop = med_rent_est*total_pop_est)
plan20 = st_join(planning_districts,census20) %>% group_by(Communit_1) %>% summarize(tot_pop20 = sum(total_pop_est), avg_med_inc20 = (sum(med_incxpop)/tot_pop20), avg_dens20 = mean(pop_dens20), tot_youth20 = sum(pop_18_34_est), perc_youth_20 = mean(perc_youth), avg_med_rent20 = (sum(med_rentxpop)/tot_pop20), tot_rent_HH_20 = sum(rental_units_est))

## create dataset with council districts containing aggregated census data from both years AND further calculated columns (percent change population, percent change average median income, percent change in population density)
plan_dist = 
  left_join(st_drop_geometry(plan10), st_drop_geometry(plan20), by="Communit_1") %>%
  left_join(.,planning_districts,by="Communit_1") %>%
  st_as_sf() %>% 
  mutate(perc_chg_pop = round(((tot_pop20-tot_pop10)/tot_pop10)*100,1), perc_chg_med_inc = round(((avg_med_inc20-avg_med_inc10)/avg_med_inc10)*100,1), perc_chg_dens = round(((avg_dens20-avg_dens10)/avg_dens10)*100,1), perc_chg_med_rent = round(((avg_med_rent20-avg_med_rent10)/avg_med_rent10)*100,1), perc_chg_youth = round(((perc_youth_20-perc_youth_10)/perc_youth_10)*100,1))
```


```{r}
## aggregating venue data by council district area and creating table of council districts with census acs and venue data
variables_to_ordinal = c("ownership_structure","independent_booking","events_per_month","years_operating","funding_source","interdisciplinarity","event_promotion","purpose","community_focus","creativity","experimentation")
to_ordinal=function(vector){
  v = case_when(substr(x,1,1)=="1"~1,substr(x,1,1)=="2"~2,substr(x,1,1)=="3"~3,substr(x,1,1)=="4"~4)
  return(v)
}
venues$ownership_structure_ord = to_ordinal(venues$ownership_structure)
venues$independent_booking_ord = to_ordinal(venues$independent_booking)
venues$events_per_month_ord = to_ordinal(venues$events_per_month)
venues$years_operating_ord = to_ordinal(venues$years_operating)
venues$funding_source_ord = to_ordinal(venues$funding_source)
venues$interdisciplinarity_ord = to_ordinal(venues$interdisciplinarity)
venues$event_promotion_ord = to_ordinal(venues$event_promotion)
venues$purpose_ord = to_ordinal(venues$purpose)
venues$community_focus_ord = to_ordinal(venues$community_focus)
venues$creativity_ord = to_ordinal(venues$creativity)
venues$experimentation_ord = to_ordinal(venues$experimentation)



plan_dist_venues = st_join(plan_dist, select(venues,-c(all_of(variables_to_ordinal),X,name,liaison,description,contact_name,contact_email,contact_telephone,address,street,genre,APN,url,zip,county,city,y,x))) %>% 
#not sure why NAs are introduced  
  group_by(Communit_1) %>% 
  summarize(num_venues = n(),
            avg_capacity = mean(as.numeric(capacity),na.rm=TRUE),
            ownership_structure = mean(ownership_structure_ord,na.rm=TRUE),
            independent_booking = mean(independent_booking_ord,na.rm=TRUE),
            events_per_month = mean(events_per_month_ord,na.rm=TRUE),
            years_operating = mean(years_operating_ord,na.rm=TRUE),
            funding_source = mean(funding_source_ord,na.rm=TRUE),
            interdisciplinarity = mean(interdisciplinarity_ord,na.rm=TRUE),
            event_promotion = mean(event_promotion_ord,na.rm=TRUE),
            purpose = mean(purpose_ord,na.rm=TRUE),
            community_focus = mean(community_focus_ord,na.rm=TRUE),
            creativity = mean(creativity_ord,na.rm=TRUE),
            experimentation = mean(experimentation_ord,na.rm=TRUE),
            threats_neighbors = sum(threats_neighbors,na.rm=TRUE),
            threats_cost = sum(threats_cost,na.rm=TRUE),
            threats_licensing = sum(threats_licensing,na.rm=TRUE),
            venueType_club = sum(venueType_club,na.rm=TRUE),
            venueType_disco = sum(venueType_disco,na.rm=TRUE),
            venueType_openAir = sum(venueType_openAir,na.rm=TRUE),
            venueType_concertHall = sum(venueType_concertHall,na.rm=TRUE),
            venueType_theater = sum(as.numeric(venueType_theater),na.rm=TRUE),
            venueType_cinema = sum(venueType_cinema,na.rm=TRUE),
            venueType_musicBar = sum(venueType_musicBar,na.rm=TRUE),
            venueType_gallery = sum(venueType_gallery,na.rm=TRUE),
            venueType_restaurant = sum(venueType_restaurant,na.rm=TRUE),
            venueType_warehouse = sum(venueType_warehouse,na.rm=TRUE),
            venueType_arena = sum(venueType_arena,na.rm=TRUE),
            venueType_shop = sum(venueType_shop,na.rm=TRUE),
            venueType_studio = sum(venueType_studio,na.rm=TRUE)
            ) %>% 
  left_join(., st_drop_geometry(plan_dist), by="Communit_1") %>% mutate(density_venues = num_venues/area)

```


```{r}
## creating table of venues with census acs data (aggregated by council districts) added on
#venues_dist = st_join(venues,coun_dist)

venues_dist = st_join(venues,plan_dist)

```

## Making Sense of Administrative Data

- Use *~/Github/Nashville_IMV/R/clean_data.R* clean the music venue database so that it is in a format compatible to join with other data sets. 

- Then use the code below to inspect and visualize this information.

Fire department dataset cleaning
```{r}
## load fire department data
FD = st_read("~/Github/Nashville_IMV/data/metro/Bars-&-Nightclubs-with-Occupant-Loads_2023-03-24_131105.csv")

#94 venues match, 198 venues of ours not represented inn FD, 162 FD not represented in venues
venue_all_FD_data = left_join(venue_admin_key_table,FD,by= c("address_admin"="Location.Name","APN"="Location.Property.Tax.ID")) %>% unique()

#variables_FD = c() #feel like all of them are useful

#venue_select_parcel_data = venue_all_parcel_data %>% select(all_of(variables_parcels)) 

## FD data we want
addresses_to_pull = venue_all_FD_data %>% filter(is.na(Location.Full.Address)) %>% select(APN,address_admin)
```


Parcels dataset cleaning
```{r}
## load administrative data (very time consuming)
parcels = st_read("~/Github/Nashville_IMV/data/metro/Nashville_Parcel_data.shp") %>% st_transform(4326)

venue_all_parcel_data = left_join(venue_admin_key_table,parcels,by= c("address_admin"="PropAddr","APN")) %>% unique()

variables_parcels = c("name", "address_admin", "APN", "TotlAppr", "SalePrice", "Acres", "FinishArea", "LUDesc", "Owner", "geometry")

venue_select_parcel_data = venue_all_parcel_data %>% select(all_of(variables_parcels)) %>% mutate(Area_sqft = Acres*43560)
#area is of parcel not building so I will not calculate price/sqft just yet
#will get centroids from venues table rather than re-calculating
```

Business Licenses Dataset cleaning
```{r}
business_licenses = read.csv("~/Github/Nashville_IMV/data/metro/Business_Property.csv")

venue_all_business_data = left_join(venue_admin_key_table,business_licenses,by="APN")

variables_business = c("name","BUSNAME","address_admin","PropAddr","APN","BUSTYPE","OWNER","APPRVALUE","ASSDVALUE")

venue_select_business_data = select(venue_all_business_data,all_of(variables_business))
```

